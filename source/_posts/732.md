---
title: 如何借助 Cloudflare 自建 NPM 镜像教程
tags:
  - 稿件
categories:
  - 资源分享
date: 2024-07-29 00:00:00
---

> 

<!-- more -->

## 

要借助 Cloudflare 自建 NPM 镜像，可以参考以下步骤：

1. **创建 Cloudflare Worker**：
   - 登录 Cloudflare 账户，转到 Workers 选项卡。
   - 创建一个新的 Worker，输入 Worker 名称（例如 `npm-mirror`），点击 `部署`。
   - 点击打开 Worker 脚本地址并复制，编辑 Worker 脚本，粘贴复制的脚本内容。

2. **编写 Worker 脚本**：
   - 脚本中需要包含对 NPM 镜像的代理逻辑。例如，可以使用以下代码作为基础：
     ```javascript
     const npmRegistry = "https://registry.npmjs.org";
     const HTML = `
     <!DOCTYPE html>
     <html lang="zh-CN">
     <head>
     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
     <link rel="shortcut icon" href="https://xiaowangye.org/assets/img/favicons/favicon.ico">
     <title>NPM 镜像代理使用说明</title>
     <style>
     body {
     ...
     </style>
     </head>
     <body>
     ...
     </body>
     </html>
     `;
     const routes = {
       // 替换为你的域名
       "npm.yourdomain.com": npmRegistry,
     };
     function routeByHosts(host) {
       if (host in routes) {
         return routes[host];
       }
       return "";
     }
     async function handleRequest(request) {
       const url = new URL(request.url);
       if (url.pathname == "/") {
         return handleHomeRequest(url.host);
       }
       const upstream = routeByHosts(url.hostname);
       if (!upstream) {
         return createNotFoundResponse(routes);
       }
       const isNpmRegistry = upstream == npmRegistry;
       const authorization = request.headers.get("Authorization");
       if (url.pathname == "/-/ping") {
         return handlePingRequest(upstream, authorization);
       }
       // get token
       if (url.pathname == "/-/auth") {
         return handleAuthRequest(upstream, url, isNpmRegistry, authorization);
       }
       return handlePullRequest(upstream, request);
     }
     function parseAuthenticate(authenticateStr) {
       ...
     }
     const createNotFoundResponse = (routes) => new Response(
       JSON.stringify({ routes }),
       {
         status: 404,
         headers: {
           "Content-Type": "application/json",
         },
       }
     );
     ```

3. **设置自定义域名**：
   - 在 Workers 和 Pages 页面中，选择你的 Worker，点击 `设置` → `触发器` → `添加自定义域`，输入自定义域名（例如 `npm.yourdomain.com`）进行绑定。

4. **配置 NPM 客户端**：
   - 在你的项目中，配置 `npm` 客户端使用你的自定义域名作为镜像源。例如：
     ```bash
     npm config set registry https://npm.yourdomain.com
     ```

5. **测试**：
   - 运行 `npm install` 命令，检查是否能够从你的自定义镜像源拉取包。

通过以上步骤，你可以利用 Cloudflare Workers 创建一个 NPM 镜像代理，从而绕过访问限制并提高访问速度。
