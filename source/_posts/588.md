---
title: 使用 Docker 部署 Bitwarden 密码管理平台
tags:
  - 部署
categories:
  - 资源分享
date: 2023-05-23 00:00:00
---

> 应海阔蓝童鞋的需求分享如何使用 Docker 部署 Bitwarden 密码管理平台的教程。因杜老师近期出差时间紧张，没有精力细致整理排版，但确保可成功部署，需要的小伙伴可以参考，如有建议可在评论区中留言！

<!-- more -->

## 准备工作

在开始部署 Bitwarden 之前，请确保已经安装 Docker。这里以 Ubuntu 为例，更新软件包索引并安装软件包以允许使用基于 HTTPS 存储库：

```
sudo apt-get update
sudo apt-get install ca-certificates curl gnupg
```

添加 Docker 官方 GPG 密钥：

```
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg
```

使用以下命令设置软件包存储库：

```
echo "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

更新索引：

```
sudo apt-get update
```

安装 Docker Engine 等相关组件：

```
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

通过运行映像以验证 Docker 引擎安装是否成功「可选」

```
sudo docker run hello-world
```

## 拉取源码

```
curl -s -L -o bitwarden.sh "https://func.bitwarden.com/api/dl/?app=self-host&platform=linux" && chmod +x bitwarden.sh
```

注意：bitwardenrs/server 镜像已过时，这里使用官方推荐的新镜像。另外如果下载速度过慢，可以留言给杜老师，杜老师可以推送到阿里云的加速镜像。

## 部署容器

```
docker run -d --name vaultwarden -v /vw-data/:/data/ -p 80:80 vaultwarden/server:latest
```

注意：这将保留/vw-data/下任何持久数据，可根据适合的路径调整路径。

## 配置密钥

在 Bitwarden 管理界面中，点击 "Settings" > "API"，然后点击 "Generate new API key" 生成一个新的 API 密钥。

将此密钥添加到您的 API 密钥管理工具中，以便您的应用程序可以访问 Bitwarden。

## 配置验证

要将 Bitwarden 集成到您的应用程序中，您需要配置一个 API 身份验证。以下是一个简单的示例，演示如何使用 JWT 身份验证将 Bitwarden 集成到 Python 应用程序中：

```Python
from flask import Flask, request, jsonify, abort
from flask_jwt_extended import JwtAuthentication, JwtError
from jwt import decode, verify
app = Flask(__name__)
app.config['JWT_SECRET_KEY'] = 'my-secret-key'
app.config['JWT_EXPIRATION_DELTA'] = 60
auth = JwtAuthentication(
    app,
    secret_key=app.config['JWT_SECRET_KEY'],
    user_claims={
        'is_admin': True,
    }
)
@app.route('/login', methods=['POST'])
def login():
    username = request.form['username']
    password = request.form['password']
    if verify(decode(username + '.' + app.config['JWT_SECRET_KEY'], app.config['JWT_EXPIRATION_DELTA']), password):
        token = app.config['JWT_SECRET_KEY'] + '.' + str(uuid.uuid4()).hex
        return jsonify({
            'token': token,
            'user': {
                'username': username,
                'is_admin': True,
            }
        }), 201
    else:
        return jsonify({
            'error': 'Invalid credentials',
            'error_description': 'Invalid username or password'
        }), 401
@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'GET':
        return jsonify({
            'token': '',
            'user': {
                'username': '',
                'is_admin': False,
            }
        })
    elif request.method == 'POST':
        token = request.form['token']
        if token == '':
            return jsonify({
                'error': 'Invalid token'
            }), 401
        else:
            user = auth.verify_token(token)
            if user:
                return jsonify({
                    'token': user['token'],
                    'user': {
                        'username': user['username'],
                        'is_admin': user['is_admin']
                    }
                }), 201
            else:
                return jsonify({
                    'error': 'Invalid token',
                    'error_description': 'Invalid token'
                }), 401
@app.route('/logout')
def logout():
    auth.remove_token(request.session['token'])
    return jsonify({
        'token': '',
        'user': {
            'username': '',
            'is_admin': False,
        }
    }), 204
if __name__ == '__main__':
    app.run(debug=True)
```

使用此代码，您可以将 Bitwarden 集成到您的 Python 应用程序中。在 `/login` 和 `/logout` 路由中，我们使用 JWT 身份验证来验证用户的身份。您需要将 Bitwarden 的 API 密钥添加到 `auth.user_claims.setdefault('is_admin', False)` 中，以便您的应用程序知道哪些用户具有管理员权限。

现在，您可以使用 Python 应用程序来访问 Bitwarden，并使用 Bitwarden 的 API 进行身份验证。

## 写在最后

前端建议用 Nginx 反向代理，并通过 SSL 加密，已保证密码的安全。

后期杜老师也会进一步整理此文，并尽可能增加应用实例。