---
title: Nginx 反代 SSL_do_handshake 问题解决思路
tags:
  - 思路
categories:
  - 运维教程
date: 2024-07-17 00:00:00
---

> 前两天收到一个来自去不图床用户的反馈，说在香港区域访问图床时出现了 502 Bad Gateway 的错误，经过排查后发现是 Nginx 反代 SSL_do_handshake 出现问题，这里分享一下该问题的解决思路。

<!-- more -->

## 

你是否遇到过使用 Nginx 反代网站时出现 502 Bad Gateway , 明明正常反代都没问题 , 可是反代就 502 Bad Gateway , 查看错误日志显示 :

初步研究问题发现是由于网站启用了 SNI ， Nginx反代默认没有加入 SNI proxy_ssl_server_name on; ，Nginx 无法成功 handshake 上游的 SSL ， 导致 502 Bad Gateway.


最近在写一个管理后台，在参考阿里云CDN交互的时候，其中一个叫回源SNI的参数项引起了我的注意，

image-20210513190524400

        虽然知道SNI且工作中Nginx上游也有用Https的情况，但并未留意过需要做特别配置，感觉可能触发到知识盲区，一番查询后发现Nginx有一个proxy_ssl_server_name参数与此相似。

Syntax:	proxy_ssl_server_name on | off;
Default:	
proxy_ssl_server_name off;
Context:	http, server, location
This directive appeared in version 1.7.0.
 
Enables or disables passing of the server name through TLS Server Name Indication extension (SNI, RFC 6066) when establishing a connection with the proxied HTTPS server.
        当端服务器为Https，反向代理时是否开启SNI，它的默认值竟然是off。一个IP绑定多个域名很常见，为什么默认不启用呢？

        光看文档我还觉得不够，还去看了下源码，SNI的处理必调用SSL_set_tlsext_host_name函数，搜索SSL_set_tlsext_host_name函数就能快速定位相关逻辑。

     参数默认关闭，当开启时，在SSL握手的时候会把HostName传给上游服务器，以便上游服务器知道用哪个证书。

使用已经知道了，接下来来测试下。


```
2024/07/15 17:14:08 [error] 245105#0: *1324376 SSL_do_handshake() failed (SSL: error:1408F10B:SSL routines:ssl3_get_record:wrong version number) while SSL handshaking to upstream, client: 69.162.124.229, server: 7bu.top, request: ＂GET / HTTP/1.1＂, upstream: ＂https://211.101.237.240:443/＂, host: ＂7bu.top＂, referrer: ＂https://7bu.top＂
```

```
proxy_ssl_name 7bu.top;
proxy_ssl_server_name on;
```

什么是SNI（服务器名称指示）？
SNI有点像邮寄包裹到公寓楼而不是独栋房子。将邮件邮寄到某人的独栋房子时，仅街道地址就足以将包裹发送给收件人。但是，当包裹进入公寓楼时，除了街道地址外，还需要公寓号码。否则，包裹可能无法送达收件人或根本无法交付。

许多 Web 服务器更像是公寓大楼而不是独栋房子：它们承载多个域名，因此仅 IP 地址不足以指示用户尝试访问哪个域。这可能会导致服务器显示错误的 SSL 证书，从而阻止或终止 HTTPS 连接——就像如果没有正确的收件人签名，包裹将无法送到指定的地址一样。

当多个网站托管在一台服务器上并共享一个IP地址，并且每个网站都有自己的SSL证书，在客户端设备尝试安全地连接到其中一个网站时，服务器可能不知道显示哪个SSL证书。这是因为SSL/TLS握手发生在客户端设备通过HTTP指示连接到某个网站之前。

服务器名称指示 (SNI) 旨在解决此问题。SNI 是 TLS 协议（以前称为 SSL 协议）的扩展，该协议在 HTTPS 中使用。它包含在 TLS/SSL 握手流程中，以确保客户端设备能够看到他们尝试访问的网站的正确 SSL 证书。该扩展使得可以在 TLS 握手期间指定网站的主机名或域名 ，而不是在握手之后打开 HTTP 连接时指定。

简而言之，即使网站https://www.example.com托管在与https://www.something.com、https://www.another-website.com和https://www.example.io 相同的地方（相同的IP地址），SNI也能让用户的设备与https://www.example.com建立安全的连接。

SNI 可防止所谓的“常见名称不匹配错误”：即客户端（用户）设备到达了网站的正确 IP 地址，但 SSL 证书上的名称与网站名称不匹配。通常这种错误会导致用户浏览器中出现“您的连接不是专用连接”错误消息。

SNI在2003年被添加为TLS/SSL的扩展；它最初不是协议的一部分。几乎所有的浏览器、操作系统和Web服务器都支持它，除了一些仍在使用的最旧的浏览器和操作系统。

服务器名称是什么？
尽管SNI代表服务器名称指示，但SNI实际上"表示"的是网站的主机名或域名，可以与实际托管该域的Web服务器的名称分开。事实上，将多个域托管在同一台服务器上很常见–在这种情况下，它们被称为虚拟主机名。

服务器名称就是计算机的名称。对于Web服务器，此名称通常对最终用户不可见，除非该服务器仅托管一个域并且该服务器名称与该域名等同。