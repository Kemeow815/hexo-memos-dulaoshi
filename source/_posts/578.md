---
title: 说说广场代码分享
tags:
  - 代码
categories:
  - 网站搭建
date: 2023-04-23 00:00:00
---

> 首先感谢下林木木童鞋，参考他的代码才有此篇教程，效果可以参考本博说说广场。杜老师不擅长前端，如有更好样式，欢迎在评论区提出建议。本教程样式不兼容所有博客模板，如有错位等问题的出现，可在评论区中留言！

<!-- more -->

## 准备工作

此篇教程兼容各类博客框架，不管用的是 Hexo/Hugo/Typecho/WordPress 都可直接使用。

若无服务器可以不用搭建 Memos，借助现有平台「如杜老师的 [https://s.dusays.com](https://s.dusays.com)」注册账户即可。

## 广场代码

```
<script>
if ("undefined" == typeof Lately) {
	const t = document.createElement("script");
	t.src = "https://fastly.jsdelivr.net/gh/Tokinx/Lately/lately.min.js", t.onload = () = > {
		Lately.init({
			target: ".bbs-date"
		})
	}, document.head.appendChild(t)
} else Lately.init({
	target: ".bbs-date"
});
const urls = [{
	host: "https://s.dusays.com/",
	creatorId: "1",
	imgsrc: "https://cravatar.cn/avatar/28b57baa4e8f13fe4292ccb2de267e30"
}, {
	host: "https://s.dusays.com/",
	creatorId: "2",
	imgsrc: "https://bu.dusays.com/2023/03/10/640b2d3bbaa65.png"
}];
var bbDom = document.querySelector("#bbs"),
	load = '<div id="load" onclick="nextFetch()" ><button class="load-btn button-load">加载更多</button></div>',
	loading = '<div class="loader"><svg class="circular" viewBox="25 25 50 50"><circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"/></svg></div>',
	bbsDatas = [],
	bbsData = {}, nextDatas = [],
	nextData = {}, limit = 2,
	page = 1,
	offset = 0,
	nextLength = 0,
	nextDom = "",
	bbUrlNow = "",
	imgsrcNow = "",
	hostNow = "",
	creIdNow = "";

function allUrls() {
	for (var t = "", a = 0; a < urls.length; a++) t += '<div class="bbs-urls " onclick="urlsNow(this)" data-host="' + urls[a].host + '" data-creatorId="' + urls[a].creatorId + '" data-imgsrc="' + urls[a].imgsrc + '" data-index="' + a + '"><img src="' + urls[a].imgsrc + '" alt=""></div>';
	t += '<div class="bbs-urls urls-button" onclick="urlsNow(this)" data-type="random"><svg t="1665928089691" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2562" width="32" height="32"><path d="M913.2 672l98.8 57.1c5.3 3.1 5.3 10.8 0 13.9l-43.4 25L710.4 924c-2.7 1.5-6-0.4-6-3.5V772c0-2.2-1.8-4-4-4H544c-70.4 0-134.4-28.8-180.8-75.2-11.1-11.1-21.2-23.2-30.1-36.1-6.4-9.2-20-9.1-26.4 0.1C260.5 723.9 183.1 768 96 768h-48c-26.5 0-48-21.5-48-48s21.5-48 48-48h48c42.5 0 82.6-16.7 112.9-47.1 30.4-30.4 47.1-70.5 47.1-112.9s-16.7-82.6-47.1-112.9C178.6 368.7 138.4 352 96 352h-48c-26.5 0-48-21.5-48-48s21.5-48 48-48h48c70.4 0 134.4 28.8 180.8 75.2 11.1 11.1 21.2 23.2 30.1 36.1 6.4 9.2 20 9.1 26.4-0.1 46.3-67 123.6-111.1 210.8-111.1H700.4c2.2 0 4-1.8 4-4V103.4c0-3.1 3.3-5 6-3.5l258.2 156 43.4 25.1c5.3 3.1 5.3 10.8 0 13.9L913.2 352 710.4 476c-2.7 1.5-6-0.4-6-3.5V356c0-2.2-1.8-4-4-4H544c-42.5 0-82.6 16.7-112.9 47.1-30.4 30.4-47.1 70.5-47.1 112.9 0 42.5 16.7 82.6 47.1 112.9C461.4 655.3 501.5 672 544 672H700.4c2.2 0 4-1.8 4-4V551.4c0-3.1 3.3-5 6-3.5L913.2 672z" p-id="2563" fill="#f5f5f5"></path></svg></div>', t = '<div id="bbs-urls">' + (t += '<div class="bbs-urls urls-button"><a href="https://dusays.com/says/"><svg t="1665929410343" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6308" width="32" height="32"><path d="M906.212134 565.732986 565.732986 565.732986 565.732986 906.212134C565.732986 926.013685 541.666486 959.972 511.97312 959.972 482.297674 959.972 458.213254 926.013685 458.213254 906.212134L458.213254 565.732986 117.734106 565.732986C97.950475 565.732986 63.97424 541.666486 63.97424 511.97312 63.97424 482.279754 97.950475 458.213254 117.734106 458.213254L458.213254 458.213254 458.213254 117.734106C458.213254 97.950475 482.297674 63.97424 511.97312 63.97424 541.666486 63.97424 565.732986 97.950475 565.732986 117.734106L565.732986 458.213254 906.212134 458.213254C925.995765 458.213254 959.972 482.279754 959.972 511.97312 959.972 541.666486 925.995765 565.732986 906.212134 565.732986Z" p-id="6309" fill="#f5f5f5"></path></svg></a></div>') + "</div>", bbDom.insertAdjacentHTML("beforebegin", t)
}

function nextFetch() {
	document.querySelector("button.button-load").textContent = "加载中……", updateHTMl(nextDatas), nextLength < 10 ? document.querySelector("button.button-load").remove() : getNextList()
}

function urlsNow(t) {
	var a = document.querySelectorAll("#bbs-urls .bbs-urls");
	if (t.classList.contains("url-now")) a[t.getAttribute("data-index")].classList.remove("url-now"), fetchBBser();
	else {
		a.forEach((function(t, s) {
			a[s].classList.remove("url-now")
		}));
		var s = document.querySelector("button.button-load");
		if (s && s.remove(), page = 1, offset = 0, bbDom.innerHTML = loading, "random" == t.getAttribute("data-type")) {
			var e = Math.round(Math.random() * (urls.length - 1));
			hostNow = urls[e].host, creIdNow = urls[e].creatorId, imgsrcNow = urls[e].imgsrc, a[e].classList.add("url-now")
		} else a[t.getAttribute("data-index")].classList.add("url-now"), hostNow = t.getAttribute("data-host"), creIdNow = t.getAttribute("data-creatorId"), imgsrcNow = t.getAttribute("data-imgsrc");
		bbUrlNow = hostNow + "api/memo?creatorId=" + creIdNow + "&rowStatus=NORMAL&limit=10", fetch(bbUrlNow).then((t = > t.json())).then((t = > {
			bbDom.innerHTML = "", bbsDatas.length = 0;
			for (var a = 0; a < t.data.length; a++) {
				var s = t.data[a];
				bbsData = {
					updatedTs: s.updatedTs,
					creatorId: s.creatorId,
					creator: s.creatorName || s.creator.nickname || s.creator.name,
					imgsrc: imgsrcNow,
					content: s.content,
					resourceList: s.resourceList,
					url: hostNow
				}, bbsDatas.push(bbsData)
			}
			updateHTMl(bbsDatas), bbDom.insertAdjacentHTML("afterend", load), bbsData.length < 10 ? document.querySelector("button.button-load").remove() : (page++, offset = 10 * (page - 1), getNextList())
		}))
	}
}

function getNextList() {
	fetch(bbUrlNow + "&offset=" + offset).then((t = > t.json())).then((t = > {
		if (nextDom = t.data, nextLength = nextDom.length, page++, offset = 10 * (page - 1), nextLength < 1) document.querySelector("button.button-load").remove();
		else {
			nextDatas.length = 0;
			for (var a = 0; a < nextDom.length; a++) {
				var s = nextDom[a];
				nextData = {
					updatedTs: s.updatedTs,
					creatorId: s.creatorId,
					creator: s.creatorName || s.creator.nickname || s.creator.name,
					imgsrc: imgsrcNow,
					content: s.content,
					resourceList: s.resourceList,
					url: hostNow
				}, nextDatas.push(nextData)
			}
		}
	}))
}
bbDom.innerHTML = loading, allUrls();
const withTimeout = (t, a) = > {
	const s = new Promise(((a, s) = > setTimeout((() = > s("Timed out after ms.")), t)));
	return Promise.race([a, s])
}, fetchBBser = async() = > {
	await Promise.allSettled(urls.map((t = > withTimeout(2e3, fetch(t.host + "api/memo?creatorId=" + t.creatorId + "&rowStatus=NORMAL&limit=" + limit).then((t = > t.json())).then((t = > t.data)))))).then((t = > {
		bbDom.innerHTML = "";
		for (var a = 0; a < t.length; a++) {
			if ("fulfilled" == t[a].status)
				for (var s = t[a].value, e = 0; e < s.length; e++) {
					var r = s[e];
					bbsData = {
						updatedTs: r.updatedTs,
						creatorId: r.creatorId,
						creator: r.creatorName || r.creator.nickname || r.creator.name,
						imgsrc: urls[a].imgsrc,
						content: r.content,
						resourceList: r.resourceList,
						url: urls[a].host
					}, bbsDatas.push(bbsData)
				}
		}
		bbsDatas.sort(compare("updatedTs")), updateHTMl(bbsDatas)
	}))
};

function compare(t) {
	return function(a, s) {
		var e = a[t];
		return s[t] - e
	}
}

function uniqueFunc(t) {
	const a = new Map;
	return t.filter((t = > !a.has(t.creator) && a.set(t.creator, 1)))
}

function updateHTMl(t) {
	var a, s = "";
	const e = /#([^\s#]+?) /g, r = /<a.*?href="https:\/\/www\.bilibili\.com\/video\/((av[\d]{1,10})|(BV([\w]{10})))\/?".*?>.*<\/a>/g, c = /<a.*?href="https:\/\/music\.163\.com\/.*id=([0-9]+)".*?>.*<\/a>/g, o = /<a.*?href="https\:\/\/y\.qq\.com\/.*(\/[0-9a-zA-Z]+)(\.html)?".*?>.*?<\/a>/g, d = /<a.*?href="https:\/\/v\.qq\.com\/.*\/([a-z|A-Z|0-9]+)\.html".*?>.*<\/a>/g, i = /<a.*?href="https:\/\/v\.youku\.com\/.*\/id_([a-z|A-Z|0-9|==]+)\.html".*?>.*<\/a>/g, n = /<a.*?href="https:\/\/www\.youtube\.com\/watch\?v\=([a-z|A-Z|0-9]{11})\".*?>.*<\/a>/g;
	marked.setOptions({
		breaks: !0,
		smartypants: !0,
		langPrefix: "language-"
	});
	for (var l = 0; l < t.length; l++) {
		var m = t[l].url,
			u = t[l].content.replace(e, "<span class='tag-span'>#$1</span> ");
		if (u = marked.parse(u).replace(r, "<div class='video-wrapper'><iframe src='//player.bilibili.com/player.html?bvid=$1&as_wide=1&high_quality=1&danmaku=0' scrolling='no' border='0' frameborder='no' framespacing='0' allowfullscreen='true'></iframe></div>").replace(c, "<meting-js auto='https://music.163.com/#/song?id=$1'></meting-js>").replace(o, "<meting-js auto='https://y.qq.com/n/yqq/song$1.html'></meting-js>").replace(d, "<div class='video-wrapper'><iframe src='//v.qq.com/iframe/player.html?vid=$1' allowFullScreen='true' frameborder='no'></iframe></div>").replace(i, "<div class='video-wrapper'><iframe src='https://player.youku.com/embed/$1' frameborder=0 'allowfullscreen'></iframe></div>").replace(n, "<div class='video-wrapper'><iframe src='https://www.youtube.com/embed/$1' title='YouTube video player' frameborder='0' allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture' allowfullscreen title='YouTube Video'></iframe></div>"), t[l].resourceList && t[l].resourceList.length > 0) {
			for (var b = t[l].resourceList, h = "", p = "", g = 0, f = 0; f < b.length; f++) {
				var v = b[f].type.slice(0, 5),
					y = b[f].externalLink,
					w = "",
					I = "";
				y ? w = y : (I = b[f].publicId || b[f].filename, w = m + "o/r/" + b[f].id + "/" + I), "image" == v && (h += '<figure class="gallery-thumbnail"><img class="img thumbnail-image" src="' + w + '"/></figure>', g += 1), "image" !== v && (p += '<a target="_blank" rel="noreferrer" href="' + w + '">' + b[f].filename + "</a>")
			}
			if (h) {
				var L = "";
				if (1 !== g) L = "grid grid-" + g;
				u += '<div class="resimg ' + L + '">' + h + "</div></div>"
			}
			p && (u += '<div class="resour">' + p + "</div>")
		}
		s += '<li class=""><div class="bbs-avatar"><img src="' + t[l].imgsrc + '" alt=""><a href="' + t[l].url + "u/" + t[l].creatorId + '" target="_blank" rel="noopener noreferrer" class="bbs-creator">' + t[l].creator + '</a><span class="bbs-dot">·</span><span class="bbs-date">' + new Date(1e3 * t[l].updatedTs).toLocaleString() + '</span></div><div class="bbs-content"><div class="bbs-text">' + u + "</div></div></li>"
	}
	a = "<section class='bbs-timeline'><ul class='list'>" + s + "</ul></section>", bbDom.insertAdjacentHTML("beforeend", a);
	var x = document.querySelector("button.button-load");
	x && (x.textContent = "加载更多"), window.ViewImage && ViewImage.init(".bbs-content img"), window.Lately && Lately.init({
		target: ".bbs-date"
	})
}
fetchBBser();
</script>
```

注意：如需增加站点，可增加 `const urls` 字段，注意格式。

## 样式代码

```
<style>
#bbs{padding: 2rem 0;}
#bbs-urls{margin-top: 2rem;}
.bbs-urls{display:inline-block;background: #4a4b50;border-radius:10%;margin:0 .6rem 0 0;padding:4px;width:3.4rem;height:3.4rem;cursor: pointer;vertical-align: text-bottom;}
.bbs-urls img{border-radius:50%;width:100%;height:100%;}
.bbs-urls.url-now{background:#42b983;transition: 0.6s;}
.urls-button svg.icon{padding:10px;width:100%;height: 100%;}
.bbs-timeline ul {margin:0;padding: 0;}
.bbs-timeline ul li{list-style-type:none;position:relative;}
.bbs-timeline{max-width:1200px;margin:0 auto;}
.bbs-avatar{position: relative;}
.bbs-avatar img{width:24px;height:24px;border-radius:50%;margin-right:1rem;}
div.bbs-avatar > img {
    display: inline-block;
    margin: 0 10px 0 0;
}
.bbs-creator,.bbs-date,.bbs-dot{position:relative;top:-5px;}
.bbs-dot{font-weight: 800;margin:0 .5rem;}
.bbs-content {margin-bottom: 3rem;}
.bbs-text,.resour{background: var(--color-block);border-radius: 8px;font-size: 1em;padding:10px 14px;position: relative;}
.resour{font-size: 0.9rem;margin-top: 2px;padding: 5px 14px;}
.bbs-text{overflow:hidden;max-height:90vh;}
.bbs-text blockquote{font-family: KaiTi,STKaiti,STFangsong;margin:0 0 0 1rem;padding:.25rem 2rem;position: relative;border-left:0 none;}
.bbs-text blockquote::before{line-height: 2rem;content: "“";font-family: Georgia, serif;font-size: 28px;font-weight: bold;position: absolute;left: 10px;top:5px;}
.bbs-text p{margin:0;}
.bbs-text pre p{display: inline-block;}
.bbs-text pre p:empty{display: none;}
.tag-span{color: #42b983;}
#load button.load-btn{width:100%;padding:8px 0;background: var(--color-block);}
#bb-footer{letter-spacing:8px;margin:5rem auto 1rem;text-align:center;}
.dark .bbs-text,.dark .resour{background:#4a4b50;}
.dark .bbs-text p{color:#fafafa;}
.loader {position: relative;margin:3rem auto;width: 100px;}
.loader::before {content: '';display: block;padding-top: 100%;}
.circular {animation: rotate 2s linear infinite;height: 100%;transform-origin: center center;width: 100%;position: absolute;top: 0;bottom: 0;left: 0;right: 0;margin: auto;}
.path {stroke-dasharray: 1, 200;stroke-dashoffset: 0;animation: dash 1.5s ease-in-out infinite, color 6s ease-in-out infinite;stroke-linecap: round;}
@keyframes rotate {100% {transform: rotate(360deg);}}
@keyframes dash {
  0% {stroke-dasharray: 1, 200;stroke-dashoffset: 0;}
  50% {stroke-dasharray: 89, 200;stroke-dashoffset: -35px;}
  100% {stroke-dasharray: 89, 200;stroke-dashoffset: -124px;}
}
@keyframes color {
  100%,0% {stroke: #d62d20;}40% {stroke: #0057e7;}66% {stroke: #008744;}80%,90% {stroke: #ffa700;}
}
.bbs-content p > img{cursor:pointer;border:1px solid #3b3d42;}
.bbs-content p:has(img.img){display: inline-block;}
.bbs-text p > img {display: block;}
.bbs-text p > img:first-child:nth-last-child(n+2),.bbs-text p > img:first-child:nth-last-child(n+2) ~ img {display: inline-block;}
.bbs-content p > img.square{height:180px;width:180px;object-fit:cover;}
.resimg.grid{
    display: grid;
    grid-template-columns: repeat(3,1fr);
    grid-template-rows:auto;
    gap: 4px;
    width: calc(100%* 2 / 3);
    box-sizing: border-box;
    margin: 4px 0 0;
}
.resimg.grid-2{
  grid-template-columns: repeat(2, 1fr);
  width: 80%;
}
.resimg.grid-4{
  grid-template-columns: repeat(2, 1fr);
  width: calc(80% * 2 / 3);
}
.resimg.grid figure.gallery-thumbnail {
  position: relative;
  width: 100%;
  height: 0;
  padding-top: 100%;
  cursor: zoom-in;
}
.resimg figure{
  text-align: left;
  max-height:50%;
}
.resimg figure img{
  max-height:50vh;
}
.resimg.grid figure, figcaption {
  margin: 0 !important;
}
.resimg.grid figure.gallery-thumbnail > img.thumbnail-image {
  position: absolute;
  left: 0;
  top: 0;
  display: block;
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: 50% 50%;
}
.video-wrapper{position:relative;padding-bottom:55%;width:100%;height:0}
.video-wrapper iframe{position:absolute;height:100%;width:100%;}
</style>
```

注意：上面的样式杜老师做了微调，效果可见本站说说广场，如不满意也可自行调整。

## 展示代码

```
<div id="bbs"></div>
<script type="text/javascript" src="https://jsd.onmicrosoft.cn/npm/marked/marked.min.js"></script>
<script type="text/javascript" src="https://jsd.onmicrosoft.cn/gh/Tokinx/ViewImage/view-image.min.js"></script>
<script type="text/javascript" src="https://jsd.onmicrosoft.cn/gh/Tokinx/Lately/lately.min.js"></script>
```

注意：根据自身需求修改对应代码，如有任何问题，可随时在评论区中留言！